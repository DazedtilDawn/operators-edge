# Operator's Edge - Active Context
# This file is mechanically validated. Structure matters.

# Current session (updated by session_start hook)
session:
  id: "20260114-understanding-first"
  started_at: "2026-01-14T10:00:00"
  note: "Understanding-First Architecture v1.0"

  state_hash_start: null
mode: "done"

# Intent verification (v1.0) - required before planning/editing
# user_wants: What the user actually asked for
# success_looks_like: Observable criteria for success
# confirmed: Must be true before non-trivial edits
intent:
  user_wants: "Implement Phase 10 Active Context Management"
  success_looks_like: "Phase 10.4 Auto-Checkpoint implemented with 28 tests, integrated into hooks"
  confirmed: true
  confirmed_at: "2026-01-19T10:00:00"

# What are we trying to achieve?
objective: "v8.0 Phase 10 Implementation - Complete"

# Current position in the plan
current_step: 0

# The plan - each step must have description, status, and proof
# Status: pending | in_progress | completed | blocked
# is_verification: true marks verification steps (required for completion)
plan: []
next_focus:
  # Gap Analysis Roadmap (P0-P2 priority)
  - "P0: Auto-detect mismatches from hook failures (PreToolUse blocks, PostToolUse unexpected state)"
  - "P1: Skill-Hook alignment validator - detect drift between skill prompts and hook code"
  - "P1: Eval Phase 2 foundation - task bank schema (defer multi-run trials)"
  - "P2: Codex CLI command parity - port missing 9 commands or document gaps"
  - "P2: Verification enforcement upgrade - block at step completion, not PATROL"
  # Original digest recommendations
  - "Refactor proof_viz.js - high edit concentration"
  # Completed (v8.0 Phase 10)
  # - "Phase 10.2: Smart Read - DONE - 39 tests"
  # - "Phase 10.4: Auto-Checkpoint - DONE - 28 tests (implemented 2026-01-19)"
  # Completed (v3.10.1)
  # - "P1: Reinforcement loop closure - DONE (v3.10.1) - proof vitality protects lessons from decay"
  # Completed (v3.10)
  # - "P0: Evergreen principles library - DONE (v3.10)"

constraints:
  - "Single canonical state - active_context.yaml is the ONLY truth"
  - "Runtime state (junction/gear/dispatch) goes in runtime: section, not separate files"
  - "Atomic writes with locking must be preserved during migration"
  - "Backward compatibility - migrate existing JSON files on first read"
  - "No breaking changes to /edge-* command behavior"

# Known risks and how we're mitigating them
risks:
  - risk: "YAML is slower than JSON for frequent writes (junction, dispatch)"
    mitigation: "Keep runtime section small, batch updates where possible, benchmark before/after"
  - risk: "Lock contention - multiple modules writing to same file"
    mitigation: "Use state_utils.atomic_yaml_write() with short critical sections"
  - risk: "Migration breaks existing sessions with JSON state"
    mitigation: "Auto-migrate JSON to YAML on first read, don't delete until confirmed working"
  - risk: "Tests depend on JSON file paths"
    mitigation: "Update test fixtures, add migration tests"

mismatches: []
  # Archived: mismatch-20260112-000001 - pytest fallback to unittest (resolved)

# Memory (lessons with reinforcement tracking)
# Decayed 27 stale lessons (2025-12-27 to 2026-01-06, reinforced <= 1, last_used > 7 days)
memory:
  # Reconciled from proof observations (v3.10.1)
  - trigger: "hooks"
    lesson: "Policy is not enforcement - hooks are enforcement"
    evergreen: true
    reinforced: 32
    last_used: "2026-01-13"
  - trigger: "paths"
    lesson: "pathlib.Path handles cross-platform paths correctly"
    reinforced: 3
    last_used: "2025-12-30"
  - trigger: "python"
    lesson: "Windows uses 'python', Mac uses 'python3' - setup script handles this"
    reinforced: 20
    last_used: "2026-01-13"
  - trigger: "archive"
    lesson: "Resolved = archived; only living context stays in active state"
    reinforced: 14
    last_used: "2026-01-13"
  - trigger: "refactoring"
    lesson: "Facade pattern enables refactoring without breaking consumers - re-export everything"
    reinforced: 3
    last_used: "2025-12-30"
  - trigger: "skills + architecture"
    lesson: "Skills are prompts Claude interprets, not code Claude executes - for mechanical enforcement, hooks must call Python modules"
    evergreen: true
    reinforced: 2
    last_used: "2026-01-03"
  - trigger: "eval integration"
    lesson: "Keep evals explicit via a single command to avoid default workflow friction."
    reinforced: 1
    last_used: "2026-01-10"
  - trigger: "eval automation"
    lesson: "Auto-triage plus warn-only defaults keeps evals low-noise while still capturing signal."
    reinforced: 1
    last_used: "2026-01-10"
  - trigger: "readonly mode + function signatures"
    lesson: "Readonly mode functions return (result, warning) tuples - warning is None on success, message on read-only skip"
    reinforced: 1
    last_used: "2026-01-12"
  - trigger: "plan mode + automatic detection"
    lesson: "Plan mode auto-detected via PreToolUse hook on EnterPlanMode - sets flag file that is_readonly() checks"
    reinforced: 1
    last_used: "2026-01-12"
  - trigger: "supervision vs training"
    lesson: "Claude doesn't fail because it doesn't know patterns - it fails because it loses track. Supervision (drift detection, context monitoring) beats training (pattern teaching)."
    evergreen: true
    reinforced: 1
    last_used: "2026-01-18"
  - trigger: "junction semantics + approve vs dismiss"
    lesson: "Approve creates one-time allowance (consumed on use), dismiss creates time-limited auto-approve (expires after TTL) - distinct use cases"
    reinforced: 1
    last_used: "2026-01-12"
  - trigger: "observations vs claims"
    lesson: "Observations are system-captured facts (files modified, tools used), claims are Claude's statements (plan status) - quality gate validates claims against observations"
    reinforced: 1
    last_used: "2026-01-12"
  - trigger: "lessons + memory + active surfacing"
    lesson: "Lessons need active surfacing (at tool use, not just session start) to be useful - dormant infrastructure = wasted wisdom"
    reinforced: 1
    last_used: "2026-01-13"
  - trigger: "proof-grounded memory + decay"
    lesson: "Proof observations (lesson_match in logs) override YAML claims (reinforced count) for decay decisions - the system's own principle of 'observations > claims' applies to itself"
    reinforced: 1
    last_used: "2026-01-13"
  - trigger: "obligations + mechanical learning"
    lesson: "Obligations bridge 'lesson surfaced' to 'lesson applied' - created in PreToolUse, auto-resolved in PostToolUse, metrics (LAR/RWR) reveal learning effectiveness"
    reinforced: 1
    last_used: "2026-01-13"
  - trigger: "measure before optimize"
    lesson: "Instrument the gap before adding complexity - track dismissal reasons (false_positive, wrong_lesson) to measure if keyword matching actually fails before adding embeddings"
    reinforced: 1
    last_used: "2026-01-13"
  - trigger: "auto-learning + file patterns"
    lesson: "Lessons can auto-learn file patterns from proof - after 3+ successful applications to similar files, the system infers a glob pattern and only surfaces lessons for matching file types"
    reinforced: 1
    last_used: "2026-01-13"


# Self-assessment
self_score:
  timestamp: "2026-01-05T08:00:00"
  checks:
    mismatch_detection:
      met: true
      note: "Caught attr vs style CSS override issue; caught stale HTML serving"
    plan_revision:
      met: true
      note: "Changed approach 3 times: attrâ†’style, added logging, regenerated HTML"
    tool_switching:
      met: true
      note: "N/A - switched debugging approaches effectively"
    memory_update:
      met: true
      note: "Captured SVG fill and HTML regeneration lessons"
    proof_generation:
      met: true
      note: "Verified with curl, user confirmed working"
    stop_condition:
      met: true
      note: "Asked user for specific console output to diagnose"
  total: 6
  level: "real_agent"

# Archive reference
archive:
  path: ".proof/archive.jsonl"
  last_prune: "2026-01-13T15:25:00"
  entries_archived: 152  # +3 TAS phases archived

# =============================================================================
# RUNTIME STATE (v5 schema - consolidated from separate JSON files)
# This section replaces junction_state.json, gear_state.json, dispatch_state.json
# =============================================================================
runtime:
  # Junction gate state (was junction_state.json)
  junction:
    pending: null
    suppressions: []
    history_tail:
    - id: "ea2db296-d6b5-436c-b6e4-7a37118c0f91"
      type: "test_type"
      decision: "approve"
      decided_at: "2026-01-13T17:11:23.065943"
  gear:
    current: "active"
    entered_at: "2026-01-14T01:02:50.928137"
    last_run_at: "2026-01-14T01:02:48.599043"
    last_transition: "patrol_to_active"
    iterations: 0
    patrol_findings_count: 15
    dream_proposals_count: 0
    completion_epoch: null
  dispatch:
    enabled: false
    state: "complete"
    iteration: 10
    stuck_count: 0
    stats:
      auto_executed: 0
      junctions_hit: 0
      objectives_completed: 1
    history:
      - action: "complete"
        result: "TAS v1.0 committed - c3fbb48"
        timestamp: "2026-01-13T23:45:00"
    junction:
      pending:
        id: "4f4f72b5-f145-4d43-bdda-df9675a05d4e"
        type: "finding_selection"
        payload:
          reason: "Select a finding to work on"
          gear: "patrol"
        created_at: "2026-01-17T12:02:57.494522"
        source: "edge"
      suppressions: []
      history_tail:
      - id: "ea2db296-d6b5-436c-b6e4-7a37118c0f91"
        type: "test_type"
        decision: "approve"
        decided_at: "2026-01-13T17:11:23.065943"
    scout: {}