# Operator's Edge - Active Context
# This file is mechanically validated. Structure matters.

# Current session (updated by session_start hook)
session:
  id: "20251230-discovery-mode"
  started_at: "2025-12-30T00:00:00"
  note: "v3.9.5 Live Server Mode - bookmark localhost:8080"

  state_hash_start: "68c413a8a31df2033deba53cb708e7f85b819196cc5643eb3a7445f16712e1dd"
# What are we trying to achieve?
objective: "Make /edge and /edge-loop self-consistent, deterministic, and race-safe with a single canonical contract (junctions, gears, persistence), and sync Claude Code skill versions"

# Current position in the plan
current_step: 11

# The plan - each step must have description, status, and proof
# Status: pending | in_progress | completed | blocked
plan:
  - description: "Define canonical contract for /edge (junction schema + gear state invariants + result structure) and align docs with code"
    status: completed
    proof: "Added docs/edge-command-contract.md with canonical /edge + /edge-loop contract, schemas, invariants, error semantics, and deviation list; referenced in CLAUDE.md."
    expected: "Single junction schema and result contract documented; clear invariants for gear transitions and persistence"
    verification: "Updated docs/specs reflect the canonical schema and invariants"
    actual: "Created contract doc and linked it in CLAUDE.md; documented schemas, invariants, and current deviations."
    delta: null
  - description: "Implement deterministic engine behavior (complete transition graph, structured results, persist gear_state every run)"
    status: completed
    proof: "Added ACTIVE→DREAM transition, persisted gear_state every run with last_run_at, and removed string-parsing control flow for approve/skip; updated tests for new transition and handler return types."
    expected: "All gears reachable; run loop uses structured fields instead of output parsing; gear_state updated on every run"
    verification: "Unit tests or manual checks confirm transitions and persisted iterations"
    actual: "Implemented ACTIVE→DREAM in gear_config/gear_engine, added last_run_at persistence per run, and refactored approve/skip to return (message, should_run); updated related tests."
    delta: null
  - description: "Unify junction handling (approve/skip/dismiss semantics, pending gate, selection flows) with single schema"
    status: completed
    proof: "Added junction_utils with junction_state.json schema, migrated edge_skill_hook to pending gate + approve/skip/dismiss via new schema, and integrated dispatch_utils with junction_state; updated tests."
    expected: "Junctions are first-class, gate execution deterministically, and are cleared/updated consistently"
    verification: "Approve/skip/dismiss behavior matches spec and no string matching is used"
    actual: "Implemented junction_state.json with history/suppression, pending gate in handle_run, and approve/skip/dismiss semantics; tests updated."
    delta: null
  - description: "Normalize error semantics and limits (patrol/dream failures, quality gate epoch, enforce/remove limits)"
    status: completed
    proof: "Active/PATROL/DREAM now block transitions on errors; patrol scan timeout enforced; completion_epoch gates quality checks; pytest run for patrol/dream tests."
    expected: "Errors are not silently treated as success; limits either enforced or removed"
    verification: "Patrol/Dream error paths and quality gate behavior match spec"
    actual: "Added completion_epoch gating in gear_engine, enforced patrol scan timeout, and prevented patrol/dream transitions on error; updated patrol/dream tests; pytest run for patrol/dream tests."
    delta: null
  - description: "Add race safety (locking + atomic writes) and edge-loop reliability (EDGE_PORT, verify server start, graceful failures)"
    status: completed
    proof: "Added file locks + atomic writes for state files; edge_loop.sh now respects EDGE_PORT, verifies server start, and handles failures gracefully; tests run for state_utils/dispatch_utils/clickup_utils."
    expected: "State writes are atomic and serialized; edge_loop uses correct port and verifies server start"
    verification: "Concurrent runs do not corrupt state; edge_loop honors EDGE_PORT"
    actual: "Implemented lock/atomic helpers in state_utils; applied to gear_state, junction_state, dispatch_state, clickup_task, and active_context mismatch writes; updated edge_loop.sh with EDGE_PORT, server verification, and non-fatal error handling; pytest run for related modules."
    delta: null
  - description: "Update tests/docs/commands to match the new contract and remove deprecated behaviors"
    status: completed
    proof: "Updated /edge and /edge-loop command docs, contract deviations, and CLAUDE.md to align with junction/gear behavior and EDGE_PORT; synced dist command docs."
    expected: "Docs and command outputs align with implementation; tests cover new schema and transitions"
    verification: "Tests or documented verification steps confirm behavior"
    actual: "Aligned /edge docs to v3.9 gear detection/transition behavior, updated junction/argument semantics, refreshed edge_loop docs, fixed contract deviations, and synced dist command docs."
    delta: "Documentation-only updates; no additional automated tests run for docs."
  - description: "Audit Claude Code skill/command versions for drift against updated contract/docs"
    status: completed
    proof: "Audit captured in active_context.yaml (targets and drift notes)."
    expected: "All Claude Code skill/command files that mirror /edge or /edge-loop are identified for sync"
    verification: "List of target files and delta notes recorded"
    actual: "Audited Claude Code targets: .claude/skills/operators-edge/SKILL.md (gear definitions/outdated; missing junction_state/gear_state + quality gate references), .claude/commands/edge-yolo.md (no junction_state source-of-truth mention), dist/operators-edge/.claude/commands/edge-yolo.md (same). Confirmed .claude/commands/edge.md and edge-loop.md already updated and copied to dist."
    delta: null
  - description: "Apply contract-aligned updates to Claude Code skill/command files and any packaged copies"
    status: completed
    proof: "Updated operators-edge skill and edge-yolo command docs; synced dist edge-yolo.md."
    expected: "Claude Code versions reflect junction_state/gear_state usage, EDGE_PORT, and current transitions"
    verification: "Diffs show parity with canonical docs; spot-check outputs"
    actual: "Updated .claude/skills/operators-edge/SKILL.md with v3.9 gear semantics, error handling, rate limit, and state file references; added junction_state source note to edge-yolo docs and synced dist copy."
    delta: null
  - description: "Finalize session state and run $edge-done."
    status: completed
    proof: "Session validation run and final state/proof recorded."
  - description: "Fix /edge status crash and add lock-timeout handling with tests"
    status: completed
    proof: "Resolved status shadowing crash, added lock timeout handling for junction actions, added tests, and synced dist hooks."
    expected: "Status is total/read-only; lock timeouts surface cleanly; tests cover new cases"
    verification: "pytest .claude/hooks/test_edge_skill_hook.py"
    actual: "Renamed junction vs step counters, added timeout handling for approve/skip/dismiss and junction persistence, added tests for status+timeouts, and copied updated hooks to dist; pytest passed."
    delta: null
# Completed work:
# v3.9.8: Eval Phase 2 Enforcement - auto-mismatch on failure, gate_on_fail blocking, 7-day retention, 43 tests
# v4.0: Operator's Edge Universal - Codex CLI adapter (9 steps, 6 skills installed to ~/.codex/skills/)
# v2.2: Code Review Fixes - quadtree animation fallback, splitLines() for cross-platform line endings, unified .node-shape class
# v2.1: Enhanced LLM Export - session context (phases, duration), related files, work timeline, phase-aware diffs
# v2.0: Performance & Quality Fixes - quadtree O(log N), search+reveal fix, diff cap 2000 chars, style consistency
# v1.9: LLM-Friendly Diff Export - one-click export (E key or button), markdown format with context + diff + analysis prompts
# v1.8: Diff Takeover Polish - flex layout fills card space, max-width 900px, height:0 trick
# v1.7: Diff Takeover Mode - click label or D key to expand diff, stats collapse, size/position persistence
# v1.6: Multi-Layout Label Visibility - tooltips with full path on all layouts, smaller fonts (7-8px), filename truncation
# v1.5: Multi-Layout Visualization - 6 layouts (Force, EdgeBundling, Treemap, CirclePacking, Sunburst, Grid) for Explorer + Story modes
# v1.4: Proof Visualizer Refactor - split 4,371 line file into 7 focused modules (94% reduction), external CSS/JS assets
# v1.3.1: Story Mode Polish - Clouds toggle button, shine/fade on touch, label readability, heatmap fix
# v1.3: Constellation Mode - brightness tiers, hover reveal, search promotes, reveal all toggle
# v1.2: Cluster Islands Layout - ring positioning, group forces, Story mode support
# v0.9.9a: Soft Territory Fixes - fullscreen layout, aura visibility, Story mode auras, toggle for both modes
# v0.9.9: Soft Territory - node auras merge into organic cluster boundaries, toggle button, replaces contours
# v0.9.8: Diff Preview - show code changes in insight card, expand/collapse, red/green styling
# v0.9.7: Import Graph - structural dependency edges in Explorer (151 edges), visual distinction, insight card badges
# v0.9.6: Luminous Membranes - focus terrain, density contours, extension colors, edge glow, purity opacity
# v0.9.5: Explorer focus mode, related files fix, dashboard skeleton, digest sparklines
# v0.9: Edge Digest - automated reflection, recommendations to next_focus, integrated into edge_loop
# v0.8.1: Layout cache, heat legend, fixed insight card anchoring, smooth mode transitions
# v0.8+: Bug fixes - graphData.edges not links, position restore manual update, story mode controls moved below graph
# v0.8: Explorer Mode - static codebase map, Story↔Explorer toggle, phase heat overlay, 105 files/242 edges
# v0.7.1: Story Mode - UX Polish: keyboard navigation (← → Space Esc), phase toast, diff scaffold
# v0.7: Story Mode - Insight Card 2.0: phase context, related files, persistence
# v0.6c: Story Mode - Bug fix: action coloring now uses inline styles to override heatmap fills
# v0.6b: Story Mode - SOTA Insight Card with fullscreen node click, sparklines, smart insights
# v0.6a: Story Mode - Interaction Mode Coloring (N1) + Intensity Glow (N2) - nodes colored by action, pulse on touch
# v0.5.2: Story Mode - fullscreen playback controls, disabled auto-refresh for stable playback
# v0.5.1: Story Mode - phase duration + CTI delta in narrative, phase_summary.json export
# v0.5: Story Mode - timeline scrubber, intent phases, playback controls, node persistence, micro-phase collapse
# v3.9.5: Live Server Mode - edge_server.py at localhost:8080, auto-starts from edge_loop.sh
# v3.9.4: Proof Visualizer v0.4.1 + Edge Loop integration (13 steps archived)
# v1: YAML state, enforcement hooks, Windows packaging
# v2: Smart orchestrator, 6-check loop, constant memory, pruning
# v2.1: Research command system - scan, prompt generation, results tracking
# v2.2: Brainstorm command - project scanning, 3-phase ideation, expert personas
# v2.3: Pragmatic Layering refactor - edge_utils.py split into 6 focused modules (10 steps, score 5/6)
# v2.4: Automated reflection - score patterns, recurring failures, improvement suggestions (8 steps, score 5/6)
# v2.5: Lesson deduplication and consolidation (9 steps, score 5/6)
# v2.6: YOLO Mode with Guardrails - reversibility-gated auto-execution (9 steps, score 6/6)
# v2.7: Dispatch Mode - YOLO as autopilot with junction gates (7 steps)
# v2.8: Scout Mode - autonomous codebase exploration when no objective (7 steps)
# v3.0: Autonomous Edge - /edge unified command, continuous loop, complexity classification, auto-plan (7 steps)
# v3.1: Discovery Mode - self-aware feature proposals from archive/lessons/patterns (6 steps)
# v3.2: ClickUp Integration - auto-create tasks from objectives, sync completion status (5 steps)
# v3.3: Discovery Filter - meta-lesson detection to reduce false positives (3 steps)
# v3.4: Lesson Extraction - mismatch + trigger = lesson, auto-capture at resolution (4 steps)
# v3.5: Risks Enforcement - mandatory failure mode planning before edits (5 steps)
# v3.6: Lessons as Living Audits - lessons auto-scan codebase for violations (7 steps, 961 tests)
# v3.7: Three Gears Mode - automatic mode switching (Active→Patrol→Dream) (8 steps, 1011 tests, score 6/6)
# v3.8: Gear Integration - /edge skill now executes Three Gears logic, 1251 tests
# v3.8.1: Architecture Review - identified skill-as-documentation vs hook-based execution gap
# v3.9: Hook-Based Gear Execution - UserPromptSubmit hook calls gear_engine, 1283 tests
# v3.9.1: Hook-Based Prune - /edge-prune now triggers prune_skill_hook.py via UserPromptSubmit, 1307 tests
# v3.9.2: Verification Field - optional verification on plan steps, PATROL flags unverified completions, 1321 tests
# v3.9.3: Quality Gate - objective completion checks before ACTIVE→PATROL transition, 1350 tests
# v3.9.6: Current Step Normalization - auto-normalize pointer when plan complete, 16 tests
# v3.9.7: Eval Failure Scout Integration - PATROL surfaces eval invariant failures, 7 new tests
# v3.9.8+: Port /edge-verify from Codex CLI - quality checks without ending session


# Auto-generated recommendations (Edge Digest)
next_focus:
  # Gap Analysis Roadmap (P0-P2 priority)
  - "P0: Auto-detect mismatches from hook failures (PreToolUse blocks, PostToolUse unexpected state)"
  - "P0: Evergreen principles library - add 'evergreen: true' flag, exempt from decay"
  - "P1: Skill-Hook alignment validator - detect drift between skill prompts and hook code"
  - "P1: Eval Phase 2 foundation - task bank schema (defer multi-run trials)"
  - "P2: Codex CLI command parity - port missing 9 commands or document gaps"
  - "P2: Verification enforcement upgrade - block at step completion, not PATROL"
  # Original digest recommendations
  - "Refactor proof_viz.js - high edit concentration"

constraints:
  - "Single canonical contract must drive CLI output, engine behavior, and docs"
  - "No silent success on errors; failures must be surfaced truthfully"
  - "Changes must remain cross-platform (no OS-specific tooling dependencies)"
  - "Avoid breaking existing /edge-* commands unless explicitly deprecated"

# Known risks and how we're mitigating them
risks:
  - risk: "Schema changes break backward compatibility with existing state files or tooling"
    mitigation: "Version schema and include migration/compat handling where needed"
  - risk: "Race-safety changes introduce deadlocks or performance regressions"
    mitigation: "Use minimal locking with timeouts and atomic writes; keep critical sections small"
  - risk: "Behavior changes diverge from docs or command expectations"
    mitigation: "Update docs/tests alongside code and add explicit deprecation notes"

# Memory (lessons with reinforcement tracking)
memory:
  - trigger: "hooks"
    lesson: "Policy is not enforcement - hooks are enforcement"
    reinforced: 4
    last_used: "2026-01-03"
  - trigger: "state change"
    lesson: "Hash comparison verifies actual change, not just existence"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "claude code"
    lesson: "Custom subagents work via .claude/agents/ (since v1.0.60) - use /agents to create"
    reinforced: 1
    last_used: "2026-01-03"
  - trigger: "paths"
    lesson: "pathlib.Path handles cross-platform paths correctly"
    reinforced: 3
    last_used: "2025-12-30"
  - trigger: "commands"
    lesson: "Claude Code commands require restart to load after installation"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "python"
    lesson: "Windows uses 'python', Mac uses 'python3' - setup script handles this"
    reinforced: 3
    last_used: "2025-12-30"
  - trigger: "windows transfer"
    lesson: "Dotfiles (.claude/) don't copy to Windows by default - use ZIP"
    reinforced: 2
    last_used: "2025-12-27"
  - trigger: "loop"
    lesson: "Enforcement ensures loop runs; adaptation makes loop intelligent"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "commands"
    lesson: "Single entry point (/edge) reduces cognitive load vs multiple commands"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "memory"
    lesson: "Memory is taste, not storage - learn what to keep vs discard"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "archive"
    lesson: "Resolved = archived; only living context stays in active state"
    reinforced: 3
    last_used: "2025-12-30"
  - trigger: "memory"
    lesson: "Constant memory by construction beats unbounded growth"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "research"
    lesson: "External handoff beats internal pretending - generate prompts for tools that do it better"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "refactoring"
    lesson: "Facade pattern enables refactoring without breaking consumers - re-export everything"
    reinforced: 3
    last_used: "2025-12-30"
  - trigger: "imports"
    lesson: "Absolute imports (not relative) work when hooks use sys.path.insert"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "dedup"
    lesson: "Theme-based similarity catches semantic duplicates that string matching misses"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "yolo"
    lesson: "Reversibility-gating provides safety without friction - auto-execute reversible, stage irreversible, block dangerous"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "classification"
    lesson: "Classification order matters - check blocked first, then auto patterns, then supervised"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "yolo"
    lesson: "Pre-tool hooks can return early with 'approve' for YOLO bypass, but hard blocks must be checked first"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "skills"
    lesson: "Skill files cache at session start - changes require restart to take effect"
    reinforced: 2
    last_used: "2025-12-28"
  - trigger: "complexity"
    lesson: "Extract helpers until main function reads like an outline - each check returns early or delegates"
    reinforced: 1
    last_used: "2025-12-30"
  - trigger: "research"
    lesson: "Always copy research prompts to clipboard with pbcopy after creating them"
    reinforced: 1
    last_used: "2025-12-30"
  - trigger: "lesson capture + timing"
    lesson: "Capture lessons at resolution (understanding moment), not at scoring (recall moment)"
    reinforced: 1
    last_used: "2026-01-03"
  - trigger: "enforcement + behavioral"
    lesson: "Mechanical enforcement beats behavioral protocol - embed in existing flows, don't add new rituals"
    reinforced: 1
    last_used: "2026-01-03"
  - trigger: "gear + mode switching"
    lesson: "State detection determines gear, transitions are events - separate 'what mode' from 'how to switch'"
    reinforced: 1
    last_used: "2026-01-03"
  - trigger: "autonomous + rate limit"
    lesson: "Rate limit autonomous features by session (max N) not by time to prevent spam without blocking"
    reinforced: 1
    last_used: "2026-01-03"
  - trigger: "three gears + operational modes"
    lesson: "Active→Patrol→Dream provides natural idle progression - doing→checking→thinking mirrors productive work cycles"
    reinforced: 1
    last_used: "2026-01-03"
  - trigger: "skills + architecture"
    lesson: "Skills are prompts Claude interprets, not code Claude executes - for mechanical enforcement, hooks must call Python modules"
    reinforced: 2
    last_used: "2026-01-03"
  - trigger: "quality gate + transitions"
    lesson: "Quality gates belong at state transitions, not session end - gate the behavior change, not the exit"
    reinforced: 1
    last_used: "2026-01-03"
  - trigger: "severity + blocking"
    lesson: "Errors block, warnings inform - severity determines whether to halt or notify"
    reinforced: 1
    last_used: "2026-01-03"
  - trigger: "lessons + stale + outdated"
    lesson: "Challenge lessons older than 7 days when relevant - tools and APIs change"
    reinforced: 1
    last_used: "2026-01-03"
  - trigger: "svg + css + inline"
    lesson: "SVG inline attributes (.attr) override CSS classes - use consistent styling approach"
    reinforced: 1
    last_used: "2026-01-04"
  - trigger: "blend mode + dark background"
    lesson: "mix-blend-mode: multiply makes colors invisible on dark backgrounds - use screen or no blend mode instead"
    reinforced: 1
    last_used: "2026-01-04"
  - trigger: "svg fill override"
    lesson: "SVG CSS class fill rules override .attr('fill') - use .style('fill') for inline styles that win over CSS"
    reinforced: 1
    last_used: "2026-01-05"
  - trigger: "proof_viz html stale"
    lesson: "proof_viz.html is static - must regenerate after code changes to proof_visualizer.py"
    reinforced: 1
    last_used: "2026-01-05"
  - trigger: "codex cli + skills"
    lesson: "Codex CLI skills go in ~/.codex/skills/<name>/SKILL.md for global availability; restart required after install"
    reinforced: 1
    last_used: "2026-01-06"
  - trigger: "diff cache"
    lesson: "Diff cache truncation (2000 chars + truncated flag) already exists in proof_viz_builders and is surfaced in proof_viz.js."
    reinforced: 1
    last_used: "2026-01-06"
  - trigger: "debug logs"
    lesson: "Guard proof_viz.js console output with PROOFVIZ_DEBUG + debugLog to avoid console spam."
    reinforced: 1
    last_used: "2026-01-06"
  - trigger: "heatmap"
    lesson: "Heatmap colors should use inline fill with important priority and clear inline fill when off to restore CSS."
    reinforced: 1
    last_used: "2026-01-06"
  - trigger: "assets path"
    lesson: "When mapping /assets/, strip query/fragment, URL-decode, resolve paths, and enforce base-dir containment to prevent traversal."
    reinforced: 1
    last_used: "2026-01-06"
  - trigger: "css transitions"
    lesson: "max-height: none cannot animate; focus-mode max-height overrides will snap by design."
    reinforced: 1
    last_used: "2026-01-06"
  - trigger: "eval integration"
    lesson: "Keep evals explicit via a single command to avoid default workflow friction."
    reinforced: 1
    last_used: "2026-01-10"
  - trigger: "eval automation"
    lesson: "Auto-triage plus warn-only defaults keeps evals low-noise while still capturing signal."
    reinforced: 1
    last_used: "2026-01-10"
  - trigger: "eval core"
    lesson: "Snapshot payloads need size caps and truncation summaries to avoid storage/perf issues."
    reinforced: 1
    last_used: "2026-01-10"
  - trigger: "eval hooks"
    lesson: "Limit eval automation to write/edit tools and keep warn-only defaults to avoid noisy gating."
    reinforced: 1
    last_used: "2026-01-10"
  - trigger: "edge-eval"
    lesson: "Keep manual eval commands as overrides even when automation is enabled."
    reinforced: 1
    last_used: "2026-01-10"


# Self-assessment
self_score:
  timestamp: "2026-01-05T08:00:00"
  checks:
    mismatch_detection:
      met: true
      note: "Caught attr vs style CSS override issue; caught stale HTML serving"
    plan_revision:
      met: true
      note: "Changed approach 3 times: attr→style, added logging, regenerated HTML"
    tool_switching:
      met: true
      note: "N/A - switched debugging approaches effectively"
    memory_update:
      met: true
      note: "Captured SVG fill and HTML regeneration lessons"
    proof_generation:
      met: true
      note: "Verified with curl, user confirmed working"
    stop_condition:
      met: true
      note: "Asked user for specific console output to diagnose"
  total: 6
  level: "real_agent"

# Archive reference
archive:
  path: ".proof/archive.jsonl"
  last_prune: "2026-01-04T03:10:00"
  entries_archived: 145
